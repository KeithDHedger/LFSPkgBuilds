#!/bin/bash -e

. /usr/share/LFSPkg/LFSFunctions

DEPENDS="OpenJDK-1.8.0.60"
if ! lfspkg -B "$DEPENDS";then
	exit 100
fi

PKGNAME="apache-ant"
TARNAME="$PKGNAME"
VERSION="1.9.6"
BUILD=${BUILD:-1}
SECTION="DEVEL"
SUFFIX="LFSPKG"
TARBALL="${TARNAME}-${VERSION}-src.tar.bz2"

scriptLog "${PKGNAME}-${VERSION}"
gettar "http://archive.apache.org/dist/ant/source/${TARBALL}" $SECTION

scriptLog "${PKGNAME}-${VERSION}"
gettar "http://anduin.linuxfromscratch.org/sources/other/junit-4.11.jar" $SECTION

scriptLog "${PKGNAME}-${VERSION}"
gettar "http://hamcrest.googlecode.com/files/hamcrest-1.3.tgz" $SECTION

PKG="${OUTPUT}/${PKGNAME}"

DOWHAT=${1:-"build"}
rm -rf "$PKG" || true
mkdir -p "$PKG"
tar -xvf "${SOURCEARCHIVES}/${SECTION}/${TARBALL}"

export JAVA_HOME
pushd "${TARNAME}-${VERSION}"
	mkdir -vp $PKG/opt/ant-${VERSION}||true

	tar -xvf ${SOURCEARCHIVES}/${SECTION}/hamcrest-1.3.tgz
	cp -v ${SOURCEARCHIVES}/${SECTION}/junit-4.11.jar hamcrest-1.3/hamcrest-core-1.3.jar lib/optional

	./build.sh -Ddist.dir=$PKG/opt/ant-${VERSION} dist
	ln -v -sfn ant-${VERSION} $PKG/opt/ant
popd

checketc $PKG
packageclean "$PKG"

pushd "$PKG"
	/usr/bin/lfspkg -n "$PKGNAME" -p "$VERSION" -d $SECTION -b $BUILD -s $SUFFIX -m
popd

case $DOWHAT in
	up*)
		lfspkg "^${PKGNAME}-[0-9][0-9]*" "${OUTPUT}/${SECTION}/${PKGNAME}-${VERSION}-${BUILD}_${SECTION}_${SUFFIX}.tar.gz" -u
		;;
	"install")
		lfspkg "${OUTPUT}/${SECTION}/${PKGNAME}-${VERSION}-${BUILD}_${SECTION}_${SUFFIX}.tar.gz" -i
		;;
	"build")
		echo "Just built"
		;;
	*)
		echo "*** Unknown command ***"
		exit 1
esac

rm -r "$PKG" "${TARNAME}-${VERSION}"
